<!DOCTYPE html>
<html>
<head>
    <title>Fraud Detection System</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<header class="navbar">
    <div>
        <div class="brand-title">Fraud Detection System</div>
        <div class="brand-sub"></div>
    </div>

    <div class="nav-actions">
        <div class="live-status">
            <span class="live-dot"></span>
            <span>Live</span>
        </div>

        <button class="btn-secondary" onclick="toggleLive()" id="liveBtn">Stop</button>
        <button class="btn-secondary" onclick="retrainModel()">Retrain</button>
        <span id="clock"></span>
    </div>
</header>

<main class="container">

    <!-- KPI -->
    <section class="metrics">
        <div class="metric-card">
            <p>Total Transactions</p>
            <h2 id="total">0</h2>
        </div>

        <div class="metric-card">
            <p>High Risk</p>
            <h2 id="fraud">0</h2>
        </div>

        <div class="metric-card">
            <p>Average Risk</p>
            <h2 id="avg">0</h2>
        </div>

        <div class="metric-card highlight">
            <p>Fraud Rate</p>
            <h2 id="fraudPercent">0%</h2>
        </div>
    </section>

    <section class="dashboard-grid">

        <div class="left-column">
            <div class="panel">
                <h3>Risk Trend</h3>
                <div id="trend"></div>
            </div>

            <div class="panel">
                <h3>Global Risk Map</h3>
                <div id="globe3d" style="height:350px;"></div>
            </div>
        </div>

        <div class="right-column">

            <div class="panel">
                <h3>Fraud Message Analyzer</h3>
                <textarea id="fraudInput" placeholder="Enter suspicious message..."></textarea>
                <button class="btn-primary full-width" onclick="analyzeText()">Analyze</button>

                <div class="analysis-result">
                    <div class="result-value" id="predictionText">â€”</div>
                    <div class="probability-bar">
                        <div id="probabilityFill"></div>
                    </div>
                    <div id="probabilityText"></div>
                </div>
            </div>

            <button class="btn-primary" onclick="downloadReport()">Download Report</button>

        </div>

    </section>

</main>

<script>
setInterval(()=>{
    document.getElementById("clock").innerText =
        new Date().toLocaleTimeString();
},1000);

let liveInterval = setInterval(fetchData,3000);
let isLive = true;

function toggleLive(){
    if(isLive){
        clearInterval(liveInterval);
        document.getElementById("liveBtn").innerText="Start";
    }else{
        liveInterval=setInterval(fetchData,3000);
        document.getElementById("liveBtn").innerText="Stop";
    }
    isLive=!isLive;
}

function retrainModel(){
    fetch("/retrain",{method:"POST"});
}

function downloadReport(){
    window.location.href="/download";
}

function analyzeText(){
    let message=document.getElementById("fraudInput").value;

    fetch("/analyze_text",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:message})
    })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("predictionText").innerText=data.prediction;
        let percent=(data.fraud_probability*100).toFixed(1);
        document.getElementById("probabilityFill").style.width=percent+"%";
        document.getElementById("probabilityText").innerText=percent+"% Probability";
    });
}

function fetchData(){
    fetch("/data")
    .then(res=>res.json())
    .then(data=>{
        let total=data.length;
        let fraud=data.filter(t=>t.Risk>0.5).length;
        let avg=data.reduce((a,b)=>a+b.Risk,0)/total;
        let fraudPercent=((fraud/total)*100).toFixed(1);

        document.getElementById("total").innerText=total;
        document.getElementById("fraud").innerText=fraud;
        document.getElementById("avg").innerText=avg.toFixed(2);
        document.getElementById("fraudPercent").innerText=fraudPercent+"%";

        Plotly.newPlot("trend",[{
            y:data.map(t=>t.Risk),
            type:"scatter",
            mode:"lines",
            line:{color:"#2563eb"}
        }],{margin:{t:10}});

        Plotly.newPlot("globe3d",[{
            type:"scattergeo",
            lat:data.map(t=>t.Latitude),
            lon:data.map(t=>t.Longitude),
            mode:"markers",
            marker:{size:5,color:data.map(t=>t.Risk),colorscale:"Blues"}
        }],{
            geo:{projection:{type:"orthographic"},showland:true,landcolor:"#e5e7eb"},
            margin:{t:0}
        });
    });
}
</script>
</body>
</html>