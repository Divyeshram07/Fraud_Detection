<!DOCTYPE html>
<html>
<head>
    <title>FraudShield AI</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<header class="navbar">
    <div class="brand">
        <h1>FraudShield AI</h1>
        <span>AI-Powered Fraud Detection System</span>
    </div>

    <div class="nav-actions">
        <button class="nav-btn" onclick="toggleLive()" id="liveBtn">Stop Live</button>
        <button class="nav-btn" onclick="downloadReport()">Download Report</button>
        <span id="clock"></span>
    </div>
</header>

<main class="container">

<!-- ================= KPI SECTION ================= -->
<section class="metrics">
    <div class="card">
        <p>Total Transactions</p>
        <h2 id="total">0</h2>
    </div>

    <div class="card danger">
        <p>High Risk</p>
        <h2 id="fraud">0</h2>
    </div>

    <div class="card">
        <p>Average Risk</p>
        <h2 id="avg">0</h2>
    </div>

    <div class="card highlight">
        <p>Fraud Rate</p>
        <h2 id="fraudPercent">0%</h2>
    </div>
</section>

<!-- ================= MAIN GRID ================= -->
<section class="dashboard-grid">

    <!-- LEFT COLUMN -->
    <div class="left-column">

        <div class="panel">
            <h3>Live Risk Trend</h3>
            <div id="trend"></div>
        </div>

        <div class="panel">
            <h3>Latest Transaction Explanation</h3>
            <div id="explanationText" class="explanation-box">
                Waiting for transaction...
            </div>
        </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="right-column">

        <div class="panel">
            <h3>Fraud Message Analyzer (NLP)</h3>

            <textarea id="messageInput"
                placeholder="Paste SMS / Email / Message here..."></textarea>

            <button class="analyze-btn" onclick="analyzeMessage()">
                Analyze Message
            </button>

            <div id="textResult" class="result-box">
                Awaiting analysis...
            </div>

            <div class="probability-bar">
                <div id="probFill"></div>
            </div>
        </div>

    </div>

</section>

</main>

<script>

// ================= CLOCK =================
setInterval(()=>{
    document.getElementById("clock").innerText =
        new Date().toLocaleTimeString();
},1000);

// ================= LIVE CONTROL =================
let liveInterval = setInterval(fetchData,3000);
let isLive = true;

function toggleLive(){
    if(isLive){
        clearInterval(liveInterval);
        document.getElementById("liveBtn").innerText="Start Live";
    }else{
        liveInterval=setInterval(fetchData,3000);
        document.getElementById("liveBtn").innerText="Stop Live";
    }
    isLive=!isLive;
}

// ================= FETCH TRANSACTION DATA =================
function fetchData(){
    fetch("/data")
    .then(res=>res.json())
    .then(data=>{
        if(!data.length) return;

        let total=data.length;
        let fraud=data.filter(t=>t.Risk>0.7).length;
        let avg=data.reduce((a,b)=>a+b.Risk,0)/total;
        let fraudPercent=((fraud/total)*100).toFixed(1);

        document.getElementById("total").innerText=total;
        document.getElementById("fraud").innerText=fraud;
        document.getElementById("avg").innerText=avg.toFixed(2);
        document.getElementById("fraudPercent").innerText=fraudPercent+"%";

        let latest=data[data.length-1];
        document.getElementById("explanationText").innerText =
            latest.Explanation;

        Plotly.newPlot("trend",[{
            y:data.map(t=>t.Risk),
            type:"scatter",
            mode:"lines",
            line:{color:"#2563eb",width:2}
        }],{margin:{t:10}});
    });
}

// ================= NLP ANALYZER =================
function analyzeMessage(){
    let message = document.getElementById("messageInput").value;

    fetch("/analyze_text",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({message:message})
    })
    .then(res=>res.json())
    .then(data=>{
        document.getElementById("textResult").innerText =
            data.prediction + " (Fraud Probability: " + (data.probability*100).toFixed(1) + "%)";

        let percent = data.probability * 100;
        document.getElementById("probFill").style.width = percent + "%";

        if(percent > 60){
            document.getElementById("probFill").style.background = "#dc2626";
        } else {
            document.getElementById("probFill").style.background = "#16a34a";
        }
    });
}

function downloadReport(){
    window.location.href="/download";
}

</script>

</body>
</html>